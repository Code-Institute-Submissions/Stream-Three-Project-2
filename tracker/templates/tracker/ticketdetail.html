{% extends 'base.html' %}
{% block title %}Issue # {{ ticket.id }}{% endblock %}
{% load crispy_forms_tags %}
{% block auxmenu %}
  {% if user.is_authenticated %}
    <a class="nav-item btn btn-outline-success mx-2" href="{% url 'tracker:form'%}">New Ticket</a>
  {% endif %}
{% endblock %}
{% block content %}
  <h1>Ticket# {{ ticket.id }}</h1>
  <p>by <strong>{{ ticket.user }}</strong></p>

  {% if user.is_authenticated  %}
    {% if ticket.type == 'BUG' or ticket.type == 'FEATURE' and user.subscription %}
    <form id='vote' action="/api-tracker/vote/" method="POST">
      <input name="ticket" type="text" value="{{ ticket.id }}" hidden />
      <input name="user" type="text" value="{{ user.id }}" hidden />  
      <button class="btn btn-success">upvote {{ ticket.votes }}</button>
    </form>
    {% else %}
    <button class="btn btn-success" disabled>upvote {{ ticket.votes }}</button>
    <p>You are a free member.</p>
    <p>You must be a paid member to vote on a 'FEATURE'.</p>
    {% endif %}
  {% endif %}

  <h2 class="mt-5">Type: <em>{{ ticket.type }}</em></h2>

  <h2 class="mt-5">Description</h2>

  <div class="text-box">
    {{ ticket.description|safe }}
  </div>
  
  <h2 class="mt-5">Comments</h2>
  {% if ticket.type == 'BUG' or ticket.type == 'FEATURE' and user.subscription %}
    <div id="disqus_thread"></div>
  {% endif %}
  <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://blogreaderpro.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
{% endblock %}

{% block aux %}
   <script>  
    $('form#vote').submit(function(e){
      e.preventDefault();
      $.ajax({
        url: '/api-tracker/vote/',
        type: 'post',
        data: $(this).serialize()
      })
      .always(function() { 
        window.location.reload(true);
      });
    });
  </script>
{% endblock %}